@using Pastures2019.Controllers
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResources> SharedLocalizer
@{
    ViewData["Title"] = SharedLocalizer["Charts"];
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/lib/сhart.js/dist/Chart.css" rel="stylesheet" />
<script src="~/lib/сhart.js/dist/Chart.js"></script>

<input id="objectid" type="hidden" value="@ViewBag.objectid" />

<select id="sourceproduct1">
    <option value="MOLT_MOD13Q1006">Terra MODIS 16-day</option>
    <option value="MOLA_MYD13Q1006">Aqua MODIS 16-day</option>
</select>
<select id="dataset1">
    <option value="NDVI">NDVI</option>
    <option value="Anomaly">@SharedLocalizer["Anomaly"]</option>
</select>
<select id="yearstart1">
    @for (int y = 2000; y <= DateTime.Today.Year; y++)
    {
        if (y == DateTime.Today.Year)
        {
            <option value="@y" selected>@y.ToString()</option>
        }
        else
        {
            <option value="@y">@y.ToString()</option>
        }
    }
</select>
<select id="yearfinish1">
    @for (int y = 2000; y <= DateTime.Today.Year; y++)
    {
        if (y == DateTime.Today.Year)
        {
            <option value="@y" selected>@y.ToString()</option>
        }
        else
        {
            <option value="@y">@y.ToString()</option>
        }
    }
</select>
<input type="button" onclick="Chart1()" value="@SharedLocalizer["Refresh"]" />
<canvas width="611" height="305" class="chartjs-render-monitor" id="chart1Canvas" style="width: 611px; height: 305px; display: block;"></canvas>
<br />
<br />

<select id="sourceproduct2">
    <option value="MOLT_MOD13Q1006">Terra MODIS 16-day</option>
    <option value="MOLA_MYD13Q1006">Aqua MODIS 16-day</option>
</select>
<select id="dataset2">
    <option value="NDVI">NDVI</option>
    <option value="Anomaly">@SharedLocalizer["Anomaly"]</option>
</select>
<select id="monthstart2">
    <option value="1" selected>1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
    <option value="7">7</option>
    <option value="8">8</option>
    <option value="9">9</option>
    <option value="10">10</option>
    <option value="11">11</option>
    <option value="12">12</option>
</select>
<select id="monthscount2">
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
    <option value="7">7</option>
    <option value="8">8</option>
    <option value="9">9</option>
    <option value="10">10</option>
    <option value="11">11</option>
    <option value="12" selected>12</option>
</select>
@for (int y = 2000; y <= DateTime.Today.Year; y++)
{
    string checkboxid = "year" + y.ToString();
    if (y != DateTime.Today.Year)
    {
        <input type="checkbox" id="@checkboxid" name="chart2years" value="@y.ToString()">
    }
    else
    {
        <input type="checkbox" id="@checkboxid" name="chart2years" value="@y.ToString()" checked>
    }
    <label for="@checkboxid">@y.ToString()</label>
}
<input type="button" onclick="Chart2()" value="@SharedLocalizer["Refresh"]" />
<canvas width="611" height="305" class="chartjs-render-monitor" id="chart2Canvas" style="width: 611px; height: 305px; display: block;"></canvas>

<select id="sourceproduct3">
    <option value="MOLT_MOD13Q1006">Terra MODIS 16-day</option>
    <option value="MOLA_MYD13Q1006">Aqua MODIS 16-day</option>
</select>
<select id="yearstart3">
    @for (int y = 2000; y <= DateTime.Today.Year; y++)
    {
        if (y == DateTime.Today.Year)
        {
            <option value="@y" selected>@y.ToString()</option>
        }
        else
        {
            <option value="@y">@y.ToString()</option>
        }
    }
</select>
<select id="yearfinish3">
    @for (int y = 2000; y <= DateTime.Today.Year; y++)
    {
        if (y == DateTime.Today.Year)
        {
            <option value="@y" selected>@y.ToString()</option>
        }
        else
        {
            <option value="@y">@y.ToString()</option>
        }
    }
</select>
<select id="type3">
    <option value="minimum">@SharedLocalizer["minimum"]</option>
    <option value="maximum">@SharedLocalizer["maximum"]</option>
    <option value="median">@SharedLocalizer["median"]</option>
</select>
<input type="button" onclick="Chart3()" value="@SharedLocalizer["Refresh"]" />
<canvas width="611" height="305" class="chartjs-render-monitor" id="chart31Canvas" style="width: 611px; height: 305px; display: block;"></canvas>
<canvas width="611" height="305" class="chartjs-render-monitor" id="chart32Canvas" style="width: 611px; height: 305px; display: block;"></canvas>
<br />
<br />
<br />

<script>
    var chart1 = null;
    function Chart1() {
        $.ajax({
            url: '@Url.Action("GetChart1Data")',
            data: {
                objectid: $('#objectid').val(),
                sourceproduct: $('#sourceproduct1').val(),
                dataset: $('#dataset1').val(),
                yearstart: $('#yearstart1').val(),
                yearfinish: $('#yearfinish1').val()
            },
            type: 'POST',
            success: function (data) {
                var color_min = random_rgba(),
                    color_max = random_rgba(),
                    color_median = random_rgba();
                var chart1Data = {
                    labels: data.labels,
                    datasets: [
                        {
                            label: '@Html.Raw(SharedLocalizer["minimum"])',
                            backgroundColor: color_min,
                            borderColor: 'rgba(215, 215, 215, 1)',
                            borderWidth: 1,
                            data: data.years_min
                        },
                        {
                            label: '@Html.Raw(SharedLocalizer["maximum"])',
                            backgroundColor: color_max,
                            borderColor: 'rgba(215, 215, 215, 1)',
                            borderWidth: 1,
                            data: data.years_max
                        },
                        {
                            label: '@Html.Raw(SharedLocalizer["median"])',
                            backgroundColor: color_median,
                            borderColor: 'rgba(215, 215, 215, 1)',
                            borderWidth: 1,
                            data: data.years_median
                        }]
                };
                var ctx1 = document.getElementById('chart1Canvas').getContext('2d');
                if (chart1 != null) {
                    chart1.destroy();
                }
                chart1 = new Chart(ctx1, {
                    type: 'bar',
                    data: chart1Data,
                    options: {
                        responsive: true,
                        scales: {
                            xAxes: [{
                                stacked: true,
                            }],
                            yAxes: [{
                                stacked: true
                            }]
                        },
                        title: {
                            display: true,
                            text: [$('#sourceproduct1 option:selected').text() + ', ' + $('#dataset1 option:selected').text() + '. ',
                                '@Html.Raw(SharedLocalizer["AllocationNumber"]): @Html.Raw(ViewBag.pasturepol.group_id)' + '. ',
                                '@Html.Raw(SharedLocalizer["Otdel"]): @Html.Raw(ViewBag.pasturepol.otdel)' + '. ',
                                '@Html.Raw(SharedLocalizer["PClass"]): @Html.Raw(ViewBag.pasturepol.ptype)' + '. ',
                                '@Html.Raw(SharedLocalizer["Group"]): @Html.Raw(ViewBag.pasturepol.group)' + '. ',
                                '@Html.Raw(SharedLocalizer["GroupLat"]): @Html.Raw(ViewBag.pasturepol.group_lat)' + '. ']
                        }
                    }
                });
            },
            error: function () {
                console.log('Error chart 1');
            }
        });
    }

    var chart2 = null;
    function Chart2() {
        var chart2years = [];
        $("input:checkbox[name=chart2years]:checked").each(function(){
            chart2years.push($(this).val());
        });
        $.ajax({
            url: '@Url.Action("GetChart2Data")',
            data: {
                objectid: $('#objectid').val(),
                sourceproduct: $('#sourceproduct2').val(),
                dataset: $('#dataset2').val(),
                monthstart: $('#monthstart2').val(),
                monthscount: $('#monthscount2').val(),
                years: chart2years
            },
            type: 'POST',
            success: function (data) {
                var chart2Data = {
                    labels: data.labels,
                    datasets: [
                        {
                            label: '@Html.Raw(SharedLocalizer["minimum"])',
                            backgroundColor: 'rgba(195, 195, 195, 1)',
                            borderColor: 'rgba(215, 215, 215, 1)',
                            data: data.years_min,
                            fill: false
                        },
                        {
                            label: '@Html.Raw(SharedLocalizer["maximum"])',
                            backgroundColor: 'rgba(195, 195, 195, 1)',
                            borderColor: 'rgba(215, 215, 215, 1)',
                            data: data.years_max,
                            fill: false
                        },
                        {
                            label: '@Html.Raw(SharedLocalizer["median"])',
                            backgroundColor: 'rgba(0, 128, 128, 1)',
                            borderColor: 'rgba(20, 148, 148, 1)',
                            data: data.years_median,
                            fill: false
                        }]
                };
                for (var i = 0; i < data.year_min_datasets.length; ++i) {
                    var color = random_rgba();
                    chart2Data.datasets.push({
                        label: data.year_min_datasets[i].year + ' @Html.Raw(SharedLocalizer["minimum"])',
                        backgroundColor: color,
                        borderColor: color,
                        data: data.year_min_datasets[i].data,
                        fill: false
                    });
                }
                for (var i = 0; i < data.year_max_datasets.length; ++i) {
                    var color = random_rgba();
                    chart2Data.datasets.push({
                        label: data.year_max_datasets[i].year + ' @Html.Raw(SharedLocalizer["maximum"])',
                        backgroundColor: color,
                        borderColor: color,
                        data: data.year_max_datasets[i].data,
                        fill: false
                    });
                }
                for (var i = 0; i < data.year_median_datasets.length; ++i) {
                    var color = random_rgba();
                    chart2Data.datasets.push({
                        label: data.year_median_datasets[i].year + ' @Html.Raw(SharedLocalizer["median"])',
                        backgroundColor: color,
                        borderColor: color,
                        data: data.year_median_datasets[i].data,
                        fill: false
                    });
                }
                var ctx2 = document.getElementById('chart2Canvas').getContext('2d');
                if (chart2 != null) {
                    chart2.destroy();
                }
                chart2 = new Chart(ctx2, {
                    type: 'line',
                    data: chart2Data,
                    options: {
                        responsive: true,
                        title: {
                            display: true,
                            text: [$('#sourceproduct2 option:selected').text() + ', ' + $('#dataset2 option:selected').text() + '. ',
                                '@Html.Raw(SharedLocalizer["AllocationNumber"]): @Html.Raw(ViewBag.pasturepol.group_id)' + '. ',
                                '@Html.Raw(SharedLocalizer["Otdel"]): @Html.Raw(ViewBag.pasturepol.otdel)' + '. ',
                                '@Html.Raw(SharedLocalizer["PClass"]): @Html.Raw(ViewBag.pasturepol.ptype)' + '. ',
                                '@Html.Raw(SharedLocalizer["Group"]): @Html.Raw(ViewBag.pasturepol.group)' + '. ',
                                '@Html.Raw(SharedLocalizer["GroupLat"]): @Html.Raw(ViewBag.pasturepol.group_lat)' + '. ']
                        }
                    }
                });
            },
            error: function () {
                console.log('Error chart 2');
            }
        });
    }

    var chart31 = null,
        chart32 = null;
    function Chart3() {
        $.ajax({
            url: '@Url.Action("GetChart3Data")',
            data: {
                objectid: $('#objectid').val(),
                sourceproduct: $('#sourceproduct3').val(),
                yearstart: $('#yearstart3').val(),
                yearfinish: $('#yearfinish3').val()
            },
            type: 'POST',
            success: function (data) {
                var color = random_rgba(),
                    color_avg = random_rgba();
                var chart31Data = { };
                if ($('#type3').val() == 'minimum') {
                    chart31Data = {
                        labels: data.labels,
                        datasets: [
                            {
                                type: 'line',
                                label: '@Html.Raw(SharedLocalizer["minimum"]) (@Html.Raw(SharedLocalizer["average"]))',
                                backgroundColor: color_avg,
                                borderColor: color_avg,
                                borderWidth: 2,
                                data: data.years_avg_min,
                                fill: false
                            },
                            {
                                type: 'bar',
                                label: '@Html.Raw(SharedLocalizer["minimum"])',
                                backgroundColor: color,
                                borderColor: 'rgba(215, 215, 215, 1)',
                                borderWidth: 1,
                                data: data.years_min
                            }
                        ]
                    };
                }
                else if ($('#type3').val() == 'maximum') {
                    chart31Data = {
                        labels: data.labels,
                        datasets: [
                            {
                                type: 'line',
                                label: '@Html.Raw(SharedLocalizer["maximum"]) (@Html.Raw(SharedLocalizer["average"]))',
                                backgroundColor: color_avg,
                                borderColor: color_avg,
                                borderWidth: 2,
                                data: data.years_avg_max,
                                fill: false
                            },
                            {
                                type: 'bar',
                                label: '@Html.Raw(SharedLocalizer["maximum"])',
                                backgroundColor: color,
                                borderColor: 'rgba(215, 215, 215, 1)',
                                borderWidth: 1,
                                data: data.years_max
                            }
                        ]
                    };
                }
                else if ($('#type3').val() == 'median') {
                    chart31Data = {
                        labels: data.labels,
                        datasets: [
                            {
                                type: 'line',
                                label: '@Html.Raw(SharedLocalizer["median"]) (@Html.Raw(SharedLocalizer["average"]))',
                                backgroundColor: color_avg,
                                borderColor: color_avg,
                                borderWidth: 2,
                                data: data.years_avg_median,
                                fill: false
                            },
                            {
                                type: 'bar',
                                label: '@Html.Raw(SharedLocalizer["median"])',
                                backgroundColor: color,
                                borderColor: 'rgba(215, 215, 215, 1)',
                                borderWidth: 1,
                                data: data.years_median
                            }]
                    };
                }
                var ctx31 = document.getElementById('chart31Canvas').getContext('2d');
                if (chart31 != null) {
                    chart31.destroy();
                }
                chart31 = new Chart(ctx31, {
                    type: 'bar',
                    data: chart31Data,
                    options: {
                        responsive: true,
                        scales: {
                            xAxes: [{
                                stacked: true,
                            }],
                            yAxes: [{
                                stacked: true
                            }]
                        },
                        title: {
                            display: true,
                            text: [$('#sourceproduct3 option:selected').text() + ', NDVI. ',
                                '@Html.Raw(SharedLocalizer["AllocationNumber"]): @Html.Raw(ViewBag.pasturepol.group_id)' + '. ',
                                '@Html.Raw(SharedLocalizer["Otdel"]): @Html.Raw(ViewBag.pasturepol.otdel)' + '. ',
                                '@Html.Raw(SharedLocalizer["PClass"]): @Html.Raw(ViewBag.pasturepol.ptype)' + '. ',
                                '@Html.Raw(SharedLocalizer["Group"]): @Html.Raw(ViewBag.pasturepol.group)' + '. ',
                                '@Html.Raw(SharedLocalizer["GroupLat"]): @Html.Raw(ViewBag.pasturepol.group_lat)' + '. ']
                        }
                    }
                });

                var chart32Data = { };
                var color_a = [];
                if ($('#type3').val() == 'minimum') {
                    for (i = 0; i < data.years_min_a.length; i++) {
                        if (data.years_min_a[i] > 0) {
                            color_a.push('rgba(0, 215, 0, 1)');
                        }
                        else {
                            color_a.push('rgba(215, 0, 0, 1)')
                        }
                    }
                    chart32Data = {
                        labels: data.labels,
                        datasets: [
                            {
                                label: '@Html.Raw(SharedLocalizer["minimum"])',
                                backgroundColor: color_a,
                                borderColor: 'rgba(215, 215, 215, 1)',
                                borderWidth: 1,
                                data: data.years_min_a,

                            }
                        ]
                    };
                }
                else if ($('#type3').val() == 'maximum') {
                    for (i = 0; i < data.years_max_a.length; i++) {
                        if (data.years_max_a[i] > 0) {
                            color_a.push('rgba(0, 215, 0, 1)');
                        }
                        else {
                            color_a.push('rgba(215, 0, 0, 1)')
                        }
                    }
                    chart32Data = {
                        labels: data.labels,
                        datasets: [
                            {
                                label: '@Html.Raw(SharedLocalizer["maximum"])',
                                backgroundColor: color_a,
                                borderColor: 'rgba(215, 215, 215, 1)',
                                borderWidth: 1,
                                data: data.years_max_a
                            }
                        ]
                    };
                }
                else if ($('#type3').val() == 'median') {
                    for (i = 0; i < data.years_median_a.length; i++) {
                        if (data.years_median_a[i] > 0) {
                            color_a.push('rgba(0, 215, 0, 1)');
                        }
                        else {
                            color_a.push('rgba(215, 0, 0, 1)')
                        }
                    }
                    chart32Data = {
                        labels: data.labels,
                        datasets: [
                            {
                                label: '@Html.Raw(SharedLocalizer["median"])',
                                backgroundColor: color_a,
                                borderColor: 'rgba(215, 215, 215, 1)',
                                borderWidth: 1,
                                data: data.years_median_a
                            }]
                    };
                }

                var ctx32 = document.getElementById('chart32Canvas').getContext('2d');
                if (chart32 != null) {
                    chart32.destroy();
                }
                chart32 = new Chart(ctx32, {
                    type: 'bar',
                    data: chart32Data,
                    options: {
                        responsive: true,
                        scales: {
                            xAxes: [{
                                stacked: true,
                            }],
                            yAxes: [{
                                stacked: true
                            }]
                        },
                        title: {
                            display: true,
                            text: [$('#sourceproduct3 option:selected').text() + ', @Html.Raw(SharedLocalizer["Anomaly"]). ',
                                '@Html.Raw(SharedLocalizer["AllocationNumber"]): @Html.Raw(ViewBag.pasturepol.group_id)' + '. ',
                                '@Html.Raw(SharedLocalizer["Otdel"]): @Html.Raw(ViewBag.pasturepol.otdel)' + '. ',
                                '@Html.Raw(SharedLocalizer["PClass"]): @Html.Raw(ViewBag.pasturepol.ptype)' + '. ',
                                '@Html.Raw(SharedLocalizer["Group"]): @Html.Raw(ViewBag.pasturepol.group)' + '. ',
                                '@Html.Raw(SharedLocalizer["GroupLat"]): @Html.Raw(ViewBag.pasturepol.group_lat)' + '. ']
                        }
                    }
                });
            },
            error: function () {
                console.log('Error chart 3');
            }
        });
    }

    function random_rgba() {
        var o = Math.round, r = Math.random, s = 255;
        //return 'rgba(' + o(r() * s) + ',' + o(r() * s) + ',' + o(r() * s) + ',' + r().toFixed(1) + ')';
        return 'rgba(' + o(r() * s) + ',' + o(r() * s) + ',' + o(r() * s) + ',1)';
    }
</script>

<script>
    $(document).ready(function () {
        Chart1();
        Chart2();
        Chart3();
    });
</script>