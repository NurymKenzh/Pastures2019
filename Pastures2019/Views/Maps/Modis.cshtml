@using Pastures2019.Controllers
@{
    ViewData["Title"] = "Modis";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/lib/ol/ol.css" rel="stylesheet" />
<link rel="stylesheet" href="~/lib/vendor/font-awesome/css/font-awesome.min.css" />
<script src="~/lib/ol/ol.js"></script>

@{
    YearDay[] yearDays = ViewBag.YearDays;
    string maxYear = yearDays.Max(y => y.year),
        maxDay = yearDays.Where(y => y.year == maxYear).Max(y => y.day);
}
<div class="container-fluid sticky-top p-0">
    <!-- Sidebar -->
    <nav class="sidebar">
        <!-- close sidebar menu -->
        <div class="dismiss">
            <i class="fa fa-arrow-left"></i>
        </div>
        <div class="logo">
            <h3>Pasture</h3>
        </div>
        <ul class="list-unstyled menu-elements m-3">
            <li class="active">
                <form>
                    <div class="form-group">
                        <label for="ModDataset">Dataset</label>
                        <select class="form-control form-control-sm" id="ModDataset">
                            <option>Terra MODIS 16-day</option>
                            <option>Aqua MODIS 16-day</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ModeProduct">Dataset</label>
                        <select class="form-control form-control-sm" id="ModeProduct">
                            <option>NDVI</option>
                            <option>NDVI Anomaly %</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="Year">Year</label>
                        <select class="form-control form-control-sm" id="Year" onchange="ChangeYear()">
                            @foreach (string year in yearDays.Select(y => y.year).Distinct().OrderBy(y => y))
                            {
                                if (year == maxYear)
                                {
                                    <option value="@year" selected>@year</option>
                                }
                                else
                                {
                                    <option value="@year">@year</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="DayOfYear">Start DOY : MM/DD Range</label>
                        <select class="form-control form-control-sm" id="DayOfYear" onchange="ChangeModis()">
                            @foreach (string day in yearDays.Where(y => y.year == maxYear).Select(y => y.day).Distinct().OrderBy(y => y))
                            {
                                if (day == maxDay)
                                {
                                    <option value="@day" selected>@day</option>
                                }
                                else
                                {
                                    <option value="@day">@day</option>
                                }
                            }
                        </select>
                    </div>
                </form>
            </li>           
            <li>
                <a href="#otherSections" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle" role="button" aria-controls="otherSections">
                    <i class="fas fa-sync"></i>Layers:
                </a>
                <ul class="collapse list-unstyled" id="otherSections">
                    <li>
                        <a class="scroll-link" href="#section-3">Base Map</a>
                    </li>
                    <li>
                        <a class="scroll-link" href="#section-4">Tematic Map</a>
                    </li>
                </ul>
            </li>
        </ul>
        <div class="dark-light-buttons">
            <a class="btn btn-primary btn-customized-4 btn-customized-dark" href="#" role="button">Dark</a>
            <a class="btn btn-primary btn-customized-4 btn-customized-light" href="#" role="button">Light</a>
        </div>
    </nav>
    <!-- End sidebar -->
    <!-- Content -->
    <div class="content">
        <!-- open sidebar menu -->
        <a class="btn btn-light btn-customized open-menu" href="#" role="button">
            <i class="fa fa-align-left"></i> <span>Menu</span>
        </a>
        <!-- Map content -->
        <div id="map" class="position-fixed col-md-12 ml-sm-auto col-lg-12 p-0 bg-light" style="height: calc(100% - 100px);"></div>
    </div>
    <!-- End content -->
</div>







@* layers *@
<script>
    var geoserver_url = '@ViewBag.GeoServerUrl', //'http://89.250.84.186:8080/geoserver/',
        geoserver_workspace_name = '@ViewBag.ModisWorkspace', //'MODIS',
        layerModisTemplate1 = '@ViewBag.ModisLayerTemplate1', //'A',
        layerModisTemplate2 = '@ViewBag.ModisLayerTemplate2'; //'_MOLT_MOD13Q1006_B01_NDVI_4326';
    var layerModis = layerModisTemplate1 + $('#Year').val() + $('#DayOfYear').val() + layerModisTemplate2;

    var Source_OSM = new ol.source.OSM();
    var Layer_Base = new ol.layer.Tile({
        source: Source_OSM
    });
    Layer_Base.set('name', 'Base');
    Layer_Base.setOpacity(0.80);

    var url_Modis = geoserver_url + geoserver_workspace_name + '/wms';
    var Source_Modis = new ol.source.TileWMS({
        url: url_Modis,
        params: {
            'FORMAT': 'image/png',
            'VERSION': '1.1.1',
            tiled: true,
            "LAYERS": geoserver_workspace_name + ':' + layerModis
        },
        serverType: 'geoserver'
    });
    var Layer_Modis = new ol.layer.Tile({
        source: Source_Modis
    });
    Layer_Modis.set('name', 'Modis');
    Layer_Modis.setOpacity(0.80);
</script>

@* map *@
<script>
    var map = new ol.Map({
        target: 'map',
        controls: new ol.control.defaults({ attributionOptions: { collapsible: true } }).extend([
            new ol.control.ScaleLine()
        ]),
        layers: [
            Layer_Base,
            Layer_Modis
        ],
        //overlays: [overlay],
        view: new ol.View({
            center: ol.proj.fromLonLat([66.902, 48.714]),
            zoom: 5
        })
    });
</script>

<script>
    function ChangeYear() {
        $("#DayOfYear").html('');
        var maxday = '001';
        for (i = 0; i < yeardays.length; i++) {
            if (yeardays[i].year == $("#Year").val().toString()) {
                if (parseInt(yeardays[i].day) > parseInt(maxday)) {
                    maxday = yeardays[i].day;
                }
            }
        }
        for (i = 0; i < yeardays.length; i++) {
            if (yeardays[i].year == $("#Year").val().toString()) {
                if (yeardays[i].day == maxday) {
                    $("#DayOfYear").append($("<option selected />").val(yeardays[i].day).text(yeardays[i].day));
                }
                else {
                    $("#DayOfYear").append($("<option />").val(yeardays[i].day).text(yeardays[i].day));
                }
            }
        }
        ChangeModis();
    }

    function ChangeModis() {
        layerModis = layerModisTemplate1 + $('#Year').val() + $('#DayOfYear').val() + layerModisTemplate2;
        Source_Modis = new ol.source.TileWMS({
            url: geoserver_url + geoserver_workspace_name + '/wms',
            params: {
                'FORMAT': 'image/png',
                'VERSION': '1.1.1',
                tiled: true,
                "LAYERS": geoserver_workspace_name + ':' + layerModis
            },
            serverType: 'geoserver'
        });
        Layer_Modis.setSource(Source_Modis);
    }
</script>

<script>
    var yeardays = [];
</script>
@foreach (YearDay yearDay in yearDays.OrderBy(y => y.year).ThenBy(y => y.day))
{
    <script>
        yeardays.push({
            year: '@yearDay.year',
            day: '@yearDay.day'
        });
    </script>
}
@*Sidebar Menu*@
<script>
    jQuery(document).ready(function () {
        /*
            Sidebar
        */
        $('.dismiss, .overlay').on('click', function () {
            $('.sidebar').removeClass('active');
        });

        $('.open-menu').on('click', function (e) {
            e.preventDefault();
            $('.sidebar').addClass('active');
            // close opened sub-menus
            $('.collapse.show').toggleClass('show');
            $('a[aria-expanded=true]').attr('aria-expanded', 'false');
        });
        /* change sidebar style */
        $('a.btn-customized-dark').on('click', function (e) {
            e.preventDefault();
            $('.sidebar').removeClass('light');
        });
        $('a.btn-customized-light').on('click', function (e) {
            e.preventDefault();
            $('.sidebar').addClass('light');
        });


    });
</script>